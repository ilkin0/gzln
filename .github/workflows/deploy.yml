name: Deploy

on:
  workflow_dispatch:

jobs:
  deploy-web:
    name: Deploy Web
    runs-on: ubuntu-latest

    steps:
      - name: Deploy Web to Dokploy
        run: |
          echo "Deploying Web..."
          response=$(curl -s -w "\n%{http_code}" -X POST "${{ secrets.DOKPLOY_API_URL }}/api/application.deploy" \
            -H "accept: application/json" \
            -H "Content-Type: application/json" \
            -H "x-api-key: ${{ secrets.DOKPLOY_API_TOKEN }}" \
            -d '{"applicationId": "${{ secrets.DOKPLOY_WEB_APP_ID }}"}')

          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)

          echo "Response: $body"
          echo "HTTP Code: $http_code"

          if [ "$http_code" -lt 200 ] || [ "$http_code" -ge 300 ]; then
            echo "::error::Deployment failed with HTTP $http_code"
            exit 1
          fi

          echo "::notice::Web deployment triggered successfully"
